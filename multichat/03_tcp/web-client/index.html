<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Web</title>
</head>

<body>
    <div id="app"></div>
    <!-- Runtime configuration override for REST, Audio WS, ICE/TURN (adjust as needed for k8s/local) -->
    <script>
        (function () {
            // Only set defaults if not already provided
            if (!window.__CHAT_CONFIG__) {
                const origin = window.location.origin;
                const host = window.location.hostname || 'localhost';
                const pagePort = window.location.port || '';
                const isHttps = window.location.protocol === 'https:';
                const wsProtocol = isHttps ? 'wss:' : 'ws:';
                const isLocal = host === 'localhost' || host === '127.0.0.1' || host.startsWith('192.168.') || host.startsWith('10.') || host.startsWith('172.');
                
                // For remote access, use the current host and appropriate ports
                let iceHost, icePort, iceUseWss, apiBaseUrl, audioWsUrl;
                
                if (isLocal && pagePort === '') {
                    // Pure localhost development (no port in URL)
                    iceHost = 'localhost';
                    icePort = 10000;
                    iceUseWss = false;
                    apiBaseUrl = 'http://localhost:3000/api';
                    audioWsUrl = 'ws://localhost:8888';
                } else {
                    // Remote access or external deployment - use current host
                    iceHost = host;
                    icePort = isHttps ? 8443 : 10000; // Use WSS port for HTTPS, WS for HTTP
                    iceUseWss = isHttps;
                    apiBaseUrl = `${origin}/api`;
                    audioWsUrl = `${wsProtocol}//${host}:${isHttps ? '8443' : '8888'}`;
                    
                    // For proxy setups (like port 31225), ICE connections need to bypass the proxy
                    // and connect directly to the server IP and port
                    if (pagePort && pagePort !== '80' && pagePort !== '443') {
                        // We're behind a proxy, use direct connection for ICE
                        iceHost = host;
                        icePort = 10000; // Always use WS port for direct connection
                        iceUseWss = false;
                    }
                }

                window.__CHAT_CONFIG__ = {
                    apiBaseUrl: apiBaseUrl,
                    audioWsUrl: audioWsUrl,
                    iceHost: iceHost,
                    icePort: icePort,
                    iceResource: '/ice',
                    iceUseWss: iceUseWss,
                    turnServers: [
                        {
                            urls: [
                                'stun:stun.l.google.com:19302',
                                'stun:stun1.l.google.com:19302',
                                'stun:stun2.l.google.com:19302'
                            ]
                        },
                        {
                            urls: [
                                'turn:openrelay.metered.ca:443?transport=tcp',
                                'turn:openrelay.metered.ca:80?transport=tcp'
                            ],
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        },
                        {
                            urls: 'turn:numb.viagenie.ca',
                            credential: 'muazkh',
                            username: 'webrtc@live.com'
                        }
                    ]
                };
            }
        })();
    </script>
    <!-- bundle.js will load Ice and then dynamically load ChatService.js -->
    <script src="bundle.js"></script>
</body>

</html>
